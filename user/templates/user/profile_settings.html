{% extends 'base.html' %}
{%block title%}
Profile Settings
{%endblock%}
{%block content%}
{% load custom_tags %}

<div class="container mx-auto px-4 py-8 max-w-4xl">
  <h1 class="text-center text-3xl font-bold text-primary mb-8">Profile Settings</h1>

  <!-- Profile Info Section -->
  <div id="profile-info"
       class="bg-base-200 rounded-xl p-6 shadow-md mb-8 transition-all duration-300 hover:shadow-lg"
       hx-trigger="load, infoChanged from:body"
       hx-get="{% url 'user:profile-info' %}"
       hx-target="#profile-info"
       hx-swap="innerHTML">
  </div>

  <!-- Profile Edit Section -->
  <div class="bg-base-200 rounded-xl p-6 shadow-md mb-8 transition-all duration-300 hover:shadow-lg">
    <div class="flex items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
      </svg>
      <h2 class="text-xl font-bold">Profile Information</h2>
    </div>
    <div class="flex justify-between items-center">
      <p class="opacity-70">Update your profile details and preferences</p>
      <button class="btn btn-primary"
        onclick="user_modal.showModal()"
        hx-get="{% url 'user:form-profile' %}"
        hx-target="#modal-response"
        hx-swap="innerHTML">
        Edit Profile
      </button>
    </div>
  </div>

  <dialog id="user_modal" class="modal">
    <div class="modal-box w-11/12 max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl">
      <h3 class="text-lg font-bold">Edit Profile</h3>
      <p class="py-4">Update your profile information</p>
      <div id="modal-response">
        <!-- Form will be loaded here via HTMX -->
      </div>
    </div>
  </dialog>

  <!-- Theme Section -->
   <div class="bg-base-200 rounded-xl p-6 shadow-md mb-8 w-full max-w-4xl">
    <div class="flex items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.401M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 0 1-3.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008Z" />
      </svg>
      <h2 class="text-xl font-bold">Appearance</h2>
    </div>
    <div class="flex justify-between items-center">
      <p class="opacity-70">Customize how the application looks</p>
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-primary">
          Change Theme
          <svg width="12px" height="12px" class="inline-block h-2 w-2 fill-current opacity-60 ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 2048">
            <path d="M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z"></path>
          </svg>
        </div>
        <form hx-post="{% url 'user:profile-theme'%}" hx-trigger="change" hx-swap="none">
          <ul tabindex="0" class="dropdown-content bg-base-300 rounded-box z-10 w-48 p-1 shadow-2xl">
            <li class="p-1">
              <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-ghost w-full text-left text-xs" aria-label="Default" value="default" />
            </li>
            <li class="p-1">
              <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-ghost w-full text-left text-xs" aria-label="Retro" value="retro" />
            </li>
            <li class="p-1">
              <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-ghost w-full text-left text-xs" aria-label="Cyberpunk" value="cyberpunk" />
            </li>
            <li class="p-1">
              <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-ghost w-full text-left text-xs" aria-label="Valentine" value="valentine" />
            </li>
            <li class="p-1">
              <input type="radio" name="theme-dropdown" class="theme-controller btn btn-sm btn-ghost w-full text-left text-xs" aria-label="Aqua" value="aqua" />
            </li>
          </ul>
        </form>
      </div>
    </div>
  </div>
  {% if not request.user|has_social_account %}
  <!-- Password Section -->
  <div class="bg-base-200 rounded-xl p-6 shadow-md mb-8 transition-all duration-300 hover:shadow-lg">
    <div class="flex items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
      </svg>
      <h2 class="text-xl font-bold">Password</h2>
    </div>
    <div class="flex justify-between items-center">
      <div>
        <p class="opacity-70">Secure your account with a strong password</p>
      </div>
      <button class="btn btn-primary"
        onclick="password_modal.showModal()"
        hx-get="{% url 'account_password_change' %}"
        hx-target="#modal-response2"
        hx-swap="innerHTML">
        Change Password
      </button>
    </div>
  </div>

  <dialog id="password_modal" class="modal">
    <div class="modal-box w-11/12 max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl">
      <h3 class="text-lg font-bold">Password Change</h3>
      <p class="py-4">Update your account password</p>
      <div id="modal-response2">
        <!-- Password form will be loaded here via HTMX -->
      </div>
    </div>
  </dialog>

  <!-- Email Section -->
  <div class="bg-base-200 rounded-xl p-6 shadow-md mb-8 transition-all duration-300 hover:shadow-lg"
  hx-trigger="load, emailChanged from:body">
    <div class="flex items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
      </svg>
      <h2 class="text-xl font-bold">Email Address</h2>
    </div>
    <div class="flex justify-between items-center">
      <div>
        <p class="opacity-70">Your current email is used for account notifications</p>
        <p>Your current email: <span class="mt-2 inline-block text-sm">{{request.user.email}}</span></p>
      </div>
      <button class="btn btn-primary"
        onclick="email_modal.showModal()"
        hx-get="{% url 'account_email' %}"
        hx-target="#modal-response3"
        hx-swap="innerHTML">
        Change Email
      </button>
    </div>
  </div>

  <dialog id="email_modal" class="modal">
    <div class="modal-box w-11/12 max-w-full sm:max-w-md md:max-w-lg lg:max-w-xl">
      <h3 class="text-lg font-bold">Email Change</h3>
      <p class="py-4">Update your email address</p>
      <p class="text-sm opacity-70">Your current email is {{request.user.email}}</p>
      <div id="modal-response3">
        <!-- Email form will be loaded here via HTMX -->
      </div>
    </div>
  </dialog>
  {% endif %}
</div>

<script>
  document.body.addEventListener("infoChanged", function() {
    document.querySelector("#user_modal").close();
  });

  document.body.addEventListener('htmx:afterSwap', (event) => {
    // Check if the swapped target is the password modal's response container
    if (event.detail.target.id === "modal-response2") {
      const pform = event.detail.target.querySelector("form");
      if (pform) {
        pform.addEventListener('submit', function(event) {
          event.preventDefault();
          document.querySelector("#password_modal").close();
        });
      }
    }

    // Check if the swapped target is the email modal's response container
    if (event.detail.target.id === "modal-response3") {
      const eform = event.detail.target.querySelector("form");
      if (eform) {
        eform.addEventListener('submit', function(event) {
          event.preventDefault();
          document.querySelector("#email_modal").close();
        });
      }
    }
  });
</script>
{%endblock%}